<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pub Quiz - EFPSA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="questions.js"></script>
    
    <style>
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob { animation: blob 7s infinite; }
        .btn-buzzer { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 20px rgba(234, 179, 8, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* New animations for Lobby */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }
    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { 
            getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, increment, 
            serverTimestamp, getDocs, deleteDoc 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { 
            Play, CheckCircle, Users, Trophy, Monitor, Smartphone, Settings, Clock, Lock, 
            MousePointerClick, Image, Video, Hand, Trash2, SkipForward, HelpCircle, Home 
        } from 'https://esm.sh/lucide-react@0.294.0';

        const INITIAL_DATA = window.INITIAL_DATA || [];
        const CATEGORIES_LIST = window.CATEGORIES_LIST || [];

        // Hasło admina
        const ADMIN_PASS = "2000";

        const firebaseConfig = {
            apiKey: "AIzaSyA1asHC5MvUOflb6PW-_Exo3-mBDIhfb5o",
            authDomain: "efpsa-6cb30.firebaseapp.com",
            projectId: "efpsa-6cb30",
            storageBucket: "efpsa-6cb30.firebasestorage.app",
            messagingSenderId: "433728974148",
            appId: "1:433728974148:web:0e132ad3877c0634e9bb11"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "pub-quiz-efpsa-v2"; 

        function PubQuizApp() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [pendingRole, setPendingRole] = useState(null);
            const [passwordInput, setPasswordInput] = useState('');
            const [passwordError, setPasswordError] = useState('');

            useEffect(() => {
                const initAuth = async () => { try { await signInAnonymously(auth); } catch (e) { console.error(e); } };
                initAuth();
                return onAuthStateChanged(auth, setUser);
            }, []);

            const handleRoleSelect = (r) => { r === 'player' ? setRole('player') : (setPendingRole(r), setPasswordInput(''), setPasswordError('')) };
            const verifyPassword = () => { passwordInput === ADMIN_PASS ? (setRole(pendingRole), setPendingRole(null)) : setPasswordError("Incorrect password"); };

            if (!user) return <div className="min-h-screen flex items-center justify-center">Connecting...</div>;

            if (pendingRole) return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-slate-800 p-8 rounded-2xl max-w-md w-full border border-slate-700">
                        <h2 className="text-2xl font-bold text-center mb-4">Password Required</h2>
                        <input type="password" value={passwordInput} onChange={e=>setPasswordInput(e.target.value)} className="w-full p-3 bg-slate-900 border rounded mb-4 text-center tracking-widest text-xl" placeholder="****" onKeyDown={e=>e.key==='Enter'&&verifyPassword()}/>
                        {passwordError && <p className="text-red-400 text-sm text-center mb-4">{passwordError}</p>}
                        <div className="flex gap-3"><button onClick={()=>setPendingRole(null)} className="flex-1 py-2 text-slate-400">Cancel</button><button onClick={verifyPassword} className="flex-1 bg-purple-600 rounded font-bold">Login</button></div>
                    </div>
                </div>
            );

            // --- REDESIGNED ROLE SELECTION ---
            if (!role) return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-slate-900">
                    <h1 className="text-6xl font-black mb-12 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 animate-pulse">PUB QUIZ</h1>
                    
                    {/* PRIMARY ACTION: JOIN AS PLAYER */}
                    <button 
                        onClick={() => handleRoleSelect('player')}
                        className="w-full max-w-md bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white p-8 rounded-3xl shadow-2xl transform transition-all hover:scale-105 mb-12 group"
                    >
                        <div className="flex flex-col items-center">
                            <Smartphone size={64} className="mb-4 text-white group-hover:rotate-12 transition-transform"/>
                            <span className="text-4xl font-black">JOIN GAME</span>
                            <span className="text-purple-200 mt-2">Click here to play!</span>
                        </div>
                    </button>

                    {/* SECONDARY ACTIONS: ADMIN/SCREEN */}
                    <div className="flex gap-4">
                        <button onClick={() => handleRoleSelect('screen')} className="flex items-center gap-2 px-6 py-3 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white transition-colors border border-slate-700">
                            <Monitor size={20}/> <span>Projector Screen</span> <Lock size={14} className="opacity-50"/>
                        </button>
                        <button onClick={() => handleRoleSelect('host')} className="flex items-center gap-2 px-6 py-3 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-white transition-colors border border-slate-700">
                            <Settings size={20}/> <span>Host Panel</span> <Lock size={14} className="opacity-50"/>
                        </button>
                    </div>
                </div>
            );

            return <div className="bg-slate-900 text-slate-100 font-sans">{role === 'host' ? <HostView user={user}/> : role === 'player' ? <PlayerView user={user}/> : <ScreenView/>}</div>;
        }

        // --- HOST VIEW ---
        function HostView({ user }) {
            const [gameState, setGameState] = useState(null);
            const [players, setPlayers] = useState([]);
            const [questions, setQuestions] = useState([]);
            const [activeCategory, setActiveCategory] = useState(null);

            useEffect(() => {
                const u1 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), d=>d.exists()&&setGameState(d.data()));
                const u2 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'players'), s=>{
                    const p=[]; s.forEach(d=>p.push({id:d.id, ...d.data()})); setPlayers(p.sort((a,b)=>b.score-a.score));
                });
                const u3 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'questions', 'list'), d=>d.exists()&&setQuestions(d.data()?.data||[]));
                return ()=>{u1();u2();u3()};
            }, []);

            const loadCategory = async (catName) => {
                if(!confirm(`Load: ${catName}?`)) return;
                setActiveCategory(catName);
                const roundQuestions = INITIAL_DATA.filter(q => q.category === catName);
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'questions', 'list'), { data: roundQuestions });
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { currentQuestionIndex: 0, status: 'lobby', timerEnd: null, revealedAnswer: false, buzzedPlayer: null });
            };

            const setStatus = async (s) => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { status: s });
            
            // NEW: Function to force Lobby screen
            const showLobby = async () => {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { status: 'lobby', timerEnd: null, revealedAnswer: false });
            };

            const nextQuestion = async () => {
                if(!gameState) return;
                const nextIdx = gameState.currentQuestionIndex + 1;
                if(nextIdx < questions.length) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { currentQuestionIndex: nextIdx, status: 'question', revealedAnswer: false, timerEnd: null, buzzedPlayer: null });
                else await setStatus('finished');
            };

            const jumpToQuestion = async (idx) => {
                if(!confirm(`Jump to question ${idx+1}?`)) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { currentQuestionIndex: idx, status: 'question', revealedAnswer: false, timerEnd: null, buzzedPlayer: null });
            };

            const startTimer = async () => {
                const dur = questions[gameState.currentQuestionIndex].time || 30;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { timerEnd: Date.now()+(dur*1000), timerDuration: dur });
            };

            const resetPlayers = async () => {
                if(!confirm("ARE YOU SURE YOU WANT TO DELETE ALL PLAYERS?")) return;
                try {
                    const q = collection(db, 'artifacts', appId, 'public', 'data', 'players');
                    const snapshot = await getDocs(q);
                    const deletePromises = [];
                    snapshot.forEach((docSnap) => deletePromises.push(deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', docSnap.id))));
                    await Promise.all(deletePromises);
                    alert("All players deleted.");
                } catch(err) { alert("Error: " + err.message); }
            };

            const revealAnswer = async () => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { revealedAnswer: true, status: 'reveal' });
            const resetBuzzer = async () => updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { buzzedPlayer: null });
            const awardBuzzer = async (pid, pts) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', pid), { score: increment(pts) }); alert(`Awarded ${pts} pts`); };

            const currentQ = questions[gameState?.currentQuestionIndex] || {};
            const isBuzzerMode = currentQ.type === 'buzzer';
            const isOpenMode = currentQ.type === 'open';

            return (
                <div className="p-4 max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-screen pb-12">
                    <div className="lg:col-span-3 space-y-2 max-h-[80vh] overflow-y-auto">
                        <h3 className="font-bold text-slate-400 mb-2">SELECT ROUND</h3>
                        {CATEGORIES_LIST.map(cat => <button key={cat} onClick={()=>loadCategory(cat)} className={`w-full text-left p-3 rounded font-bold text-sm border-l-4 transition-all ${activeCategory===cat?'bg-purple-900 border-purple-500':'bg-slate-800 border-slate-600 hover:bg-slate-700'}`}>{cat}</button>)}
                    </div>

                    <div className="lg:col-span-6 bg-slate-800 p-6 rounded-xl border border-slate-700 flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-purple-400">Host Panel</h2>
                            <span className="bg-slate-900 px-3 py-1 rounded text-xs font-mono text-yellow-500 uppercase">{gameState?.status}</span>
                        </div>
                        
                        {/* MAIN CONTROLS: LOBBY & START */}
                        <div className="grid grid-cols-2 gap-2 mb-4">
                            <button onClick={showLobby} className="bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold flex justify-center items-center gap-2"><Home size={18}/> SHOW LOBBY</button>
                            <button onClick={()=>setStatus('question')} disabled={questions.length===0} className="bg-green-600 hover:bg-green-500 py-3 rounded font-bold flex justify-center items-center gap-2 disabled:opacity-50"><Play size={18}/> START ROUND</button>
                        </div>

                        <div className="bg-slate-900 p-4 rounded mb-6 border border-slate-700 min-h-[120px]">
                            {questions.length>0 ? (
                                <><div className="text-xs text-slate-500 mb-1 flex justify-between"><span>{currentQ.category}</span><span>Question {gameState?.currentQuestionIndex+1}/{questions.length}</span></div><p className="text-lg font-bold mb-2">{currentQ.question}</p>
                                {currentQ.mediaType==='image'&&<div className="text-xs text-blue-400 flex items-center gap-1"><Image size={12}/> [Image Slide]</div>}
                                {currentQ.mediaType==='video'&&<div className="text-xs text-red-400 flex items-center gap-1"><Video size={12}/> [Video Slide]</div>}
                                {isBuzzerMode&&<p className="text-yellow-400 text-sm mt-2 font-mono">[FASTEST FINGER]</p>}
                                {isOpenMode&&<div className="mt-2 p-2 bg-purple-900/30 border border-purple-500 rounded"><p className="text-xs text-purple-400 font-bold uppercase mb-1">Answer (For Host):</p><p className="font-mono">{currentQ.answerString}</p></div>}
                                </>
                            ) : <p className="text-slate-500 italic">Select a category on the left.</p>}
                        </div>

                        <div className="flex-1 space-y-3">
                            {gameState?.status==='question' && !isBuzzerMode && !isOpenMode && (
                                <div className="flex gap-2">
                                    <button onClick={startTimer} disabled={!!gameState?.timerEnd} className="flex-1 bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold flex gap-2 justify-center"><Clock/> {gameState?.timerEnd?'Running...':'Start Timer'}</button>
                                    <button onClick={revealAnswer} className="flex-1 bg-yellow-600 hover:bg-yellow-500 py-3 rounded font-bold flex gap-2 justify-center text-black"><CheckCircle/> Reveal Ans.</button>
                                </div>
                            )}

                            {/* OPEN QUESTION CONTROLS */}
                            {gameState?.status==='question' && isOpenMode && (
                                <div className="space-y-2">
                                    <div className="flex gap-2">
                                        <button onClick={startTimer} disabled={!!gameState?.timerEnd} className="flex-1 bg-blue-600 hover:bg-blue-500 py-3 rounded font-bold flex gap-2 justify-center"><Clock/> {gameState?.timerEnd?'Running...':'Start Timer'}</button>
                                        <button onClick={revealAnswer} className="flex-1 bg-yellow-600 hover:bg-yellow-500 py-3 rounded font-bold flex gap-2 justify-center text-black"><CheckCircle/> Show Answer</button>
                                    </div>
                                    <p className="text-xs text-center text-slate-500">Open Question: No auto-scoring.</p>
                                </div>
                            )}

                            {gameState?.status==='question' && isBuzzerMode && (
                                <div className="bg-slate-700 p-3 rounded space-y-3">
                                    <div className="text-center p-2 bg-black rounded border border-slate-600"><p className="text-xs text-slate-400">BUZZED IN:</p><p className="text-2xl font-bold text-yellow-400 animate-pulse">{gameState.buzzedPlayer ? gameState.buzzedPlayer.name : "..."}</p></div>
                                    {gameState.buzzedPlayer ? (
                                        <div className="flex gap-2">
                                            <button onClick={()=>awardBuzzer(gameState.buzzedPlayer.id, currentQ.points)} className="flex-1 bg-green-600 py-2 rounded font-bold text-sm">Correct (+{currentQ.points})</button>
                                            <button onClick={()=>awardBuzzer(gameState.buzzedPlayer.id, -100)} className="flex-1 bg-red-600 py-2 rounded font-bold text-sm">Wrong (-100)</button>
                                            <button onClick={resetBuzzer} className="flex-1 bg-slate-500 py-2 rounded font-bold text-sm">Reset</button>
                                        </div>
                                    ) : <p className="text-center text-sm text-slate-400">Waiting for players...</p>}
                                </div>
                            )}

                            <div className="flex gap-2 pt-4 border-t border-slate-700">
                                <button onClick={()=>setStatus('leaderboard')} className="flex-1 bg-purple-700 hover:bg-purple-600 py-2 rounded text-sm font-bold"><Trophy size={16} className="inline"/> Leaderboard</button>
                                <button onClick={nextQuestion} className="flex-1 bg-slate-600 hover:bg-slate-500 py-2 rounded text-sm font-bold"><SkipForward size={16} className="inline"/> Next</button>
                            </div>

                            {questions.length>0 && <div className="pt-4 mt-4 border-t border-slate-700"><p className="text-xs font-bold text-slate-400 uppercase flex items-center gap-2 mb-2"><MousePointerClick size={14}/> Jump to:</p><div className="flex flex-wrap gap-2">{questions.map((q,i)=><button key={q.id} onClick={()=>jumpToQuestion(i)} className={`h-8 px-3 rounded font-bold text-sm border ${gameState?.currentQuestionIndex===i?'bg-purple-600 border-purple-400':'bg-slate-800 border-slate-600 hover:bg-slate-700'}`}>{i+1}</button>)}</div></div>}
                        </div>
                    </div>

                    <div className="lg:col-span-3 bg-slate-800 p-4 rounded-xl border border-slate-700 h-[600px] flex flex-col">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="font-bold text-blue-400 flex items-center gap-2"><Users size={16}/> PLAYERS ({players.length})</h3>
                            <button onClick={resetPlayers} className="text-red-500 hover:text-red-400 p-1 bg-red-900/30 rounded" title="Delete All Players"><Trash2 size={16}/></button>
                        </div>
                        <div className="overflow-y-auto flex-1 space-y-1">
                            {players.map((p,i)=><div key={p.id} className="flex justify-between items-center bg-slate-700 p-2 rounded text-sm"><span className="font-bold truncate w-24">{p.name}</span><span className="text-yellow-400 font-mono">{p.score}</span></div>)}
                        </div>
                    </div>
                </div>
            );
        }

        // --- PLAYER VIEW ---
        function PlayerView({ user }) {
            const [gameState, setGameState] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [myPlayer, setMyPlayer] = useState(null);
            const [teamName, setTeamName] = useState('');
            const [joined, setJoined] = useState(false);
            const [selectedOption, setSelectedOption] = useState(null);
            const [hasAnswered, setHasAnswered] = useState(false);

            useEffect(() => {
                const u1 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), d=>{
                    if(d.exists()) { const s=d.data(); setGameState(prev=>{ if(prev && prev.currentQuestionIndex !== s.currentQuestionIndex) { setSelectedOption(null); setHasAnswered(false); } return s; }); }
                });
                const u2 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'players', user.uid), d=>d.exists()&&(setMyPlayer({id:d.id, ...d.data()})||setJoined(true)));
                const u3 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'questions', 'list'), d=>d.exists()&&setQuestions(d.data()?.data||[]));
                return ()=>{u1();u2();u3()};
            }, [user]);

            const joinGame = async () => { if(teamName.trim()) await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', user.uid), { name: teamName, score: 0 }); };
            const submitOption = (i) => { if(!hasAnswered) { setSelectedOption(i); setHasAnswered(true); } };
            const hitBuzzer = async () => { if(!gameState.buzzedPlayer) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), { buzzedPlayer: { id: user.uid, name: myPlayer.name, time: Date.now() } }); };

            useEffect(() => {
                // Auto score only for 'options' type
                if(gameState?.revealedAnswer && hasAnswered && selectedOption!==null && questions[gameState.currentQuestionIndex]?.type === 'options') {
                    const q=questions[gameState.currentQuestionIndex];
                    if(q.correctAnswer===selectedOption) updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'players', user.uid), { score: increment(q.points) });
                    setHasAnswered(false);
                }
            }, [gameState?.revealedAnswer]);

            if(!joined) return <div className="flex flex-col items-center justify-center min-h-screen p-6"><h1 className="text-3xl font-bold mb-6 text-purple-400">Enter Team Name</h1><input value={teamName} onChange={e=>setTeamName(e.target.value)} className="p-4 rounded bg-slate-800 text-white w-full mb-4 text-center border" placeholder="Name..."/><button onClick={joinGame} className="w-full bg-purple-600 py-4 rounded font-bold text-xl">JOIN GAME</button></div>;
            if(gameState?.status==='lobby') return <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center"><h2 className="text-2xl font-bold">{myPlayer?.name}</h2><p className="text-slate-400 mt-2">Watch the big screen. Waiting for round.</p></div>;
            if(gameState?.status==='leaderboard') return <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center"><Trophy size={64} className="text-yellow-400 mb-4"/><h1 className="text-4xl font-bold mb-2">{myPlayer?.score}</h1><p>Your Points</p></div>;

            const currentQ = questions[gameState?.currentQuestionIndex];
            if(!currentQ) return <div>Wait...</div>;

            if(currentQ.type==='buzzer') {
                const iBuzzed = gameState.buzzedPlayer?.id === user.uid;
                const someoneBuzzed = !!gameState.buzzedPlayer;
                return <div className="min-h-screen p-6 flex flex-col items-center justify-center text-center"><div className="mb-8"><span className="text-xs bg-yellow-600 text-black px-2 py-1 rounded font-bold">FASTEST FINGER</span><p className="mt-4 text-xl font-bold">{currentQ.question}</p></div>{iBuzzed ? <div className="bg-green-600 p-8 rounded-full animate-bounce"><CheckCircle size={64} color="white"/></div> : <button onClick={hitBuzzer} disabled={someoneBuzzed} className={`w-64 h-64 rounded-full font-black text-2xl shadow-xl transition-all active:scale-95 flex flex-col items-center justify-center ${someoneBuzzed ? 'bg-slate-700 text-slate-500' : 'bg-red-600 hover:bg-red-500 text-white btn-buzzer border-8 border-red-800'}`}><Hand size={48} className="mb-2"/>{someoneBuzzed?'TOO LATE':'BUZZ!'}</button>}</div>;
            }

            if(currentQ.type==='open') {
                return (
                    <div className="min-h-screen p-6 flex flex-col items-center justify-center text-center">
                        <div className="mb-8"><span className="text-xs bg-blue-600 text-white px-2 py-1 rounded font-bold">OPEN QUESTION</span><p className="mt-4 text-xl font-bold">{currentQ.question}</p></div>
                        <div className="bg-slate-800 p-6 rounded-xl border border-slate-700">
                            <HelpCircle size={64} className="mx-auto text-blue-400 mb-4"/>
                            <p className="text-slate-400">Think about your answer or write it down!</p>
                            {gameState?.status === 'reveal' && (
                                <div className="mt-4 pt-4 border-t border-slate-700 animate-fade-in">
                                    <p className="text-sm text-slate-500 mb-1">ANSWER:</p>
                                    <p className="text-xl font-bold text-green-400">{currentQ.answerString}</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            return <div className="min-h-screen flex flex-col bg-slate-900"><div className="p-4 bg-slate-800 flex justify-between"><span className="font-bold">{myPlayer?.name}</span><span className="text-yellow-400 font-mono">{myPlayer?.score} pts</span></div><div className="flex-1 p-4 flex flex-col justify-center">{gameState?.status==='reveal' ? <div className="text-center">{selectedOption===currentQ.correctAnswer?<div className="text-green-500"><CheckCircle size={80} className="mx-auto"/><h2 className="text-3xl font-bold">CORRECT!</h2></div>:<div className="text-red-500"><XCircle size={80} className="mx-auto"/><h2 className="text-3xl font-bold">WRONG</h2></div>}</div> : <div className="grid gap-4">{currentQ.options.map((opt,i)=><button key={i} onClick={()=>submitOption(i)} disabled={hasAnswered} className={`h-20 rounded-lg font-bold text-xl ${['bg-red-600','bg-blue-600','bg-yellow-500','bg-green-600'][i]} ${hasAnswered&&selectedOption!==i?'opacity-30':''} ${selectedOption===i?'ring-4 ring-white':''}`}>{['▲','◆','●','■'][i]}</button>)}</div>}</div></div>;
        }

        // --- SCREEN VIEW ---
        function ScreenView() {
            const [gameState, setGameState] = useState(null);
            const [questions, setQuestions] = useState([]);
            const [players, setPlayers] = useState([]);
            const [timeLeft, setTimeLeft] = useState(0);

            useEffect(() => {
                const u1 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'gameState', 'main'), d=>d.exists()&&setGameState(d.data()));
                const u2 = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'questions', 'list'), d=>d.exists()&&setQuestions(d.data()?.data||[]));
                const u3 = onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'players'), s=>{
                    const p=[]; s.forEach(d=>p.push({id:d.id, ...d.data()})); setPlayers(p.sort((a,b)=>b.score-a.score));
                });
                return ()=>{u1();u2();u3()};
            }, []);

            useEffect(() => {
                if(!gameState?.timerEnd) { setTimeLeft(0); return; }
                const i = setInterval(() => { const d = Math.ceil((gameState.timerEnd - Date.now())/1000); setTimeLeft(d>0?d:0); }, 200);
                return () => clearInterval(i);
            }, [gameState?.timerEnd]);

            if (!gameState) return <div className="bg-black min-h-screen text-white flex items-center justify-center">Waiting...</div>;
            
            // --- ENHANCED LOBBY SCREEN ---
            if (gameState.status === 'lobby') {
                const currentCategory = questions[0]?.category;
                return (
                    <div className="fixed inset-0 overflow-hidden bg-slate-900 flex flex-col items-center justify-center text-white relative">
                        {/* Animated Background */}
                        <div className="absolute top-0 left-0 w-96 h-96 bg-purple-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
                        <div className="absolute bottom-0 right-0 w-96 h-96 bg-blue-600 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>
                        
                        <div className="z-10 text-center flex flex-col items-center w-full max-w-5xl">
                            <h1 className="text-9xl font-black mb-8 text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600 animate-float drop-shadow-2xl">PUB QUIZ</h1>
                            
                            {currentCategory ? (
                                <div className="mb-12 animate-fade-in-up">
                                    <p className="text-slate-400 text-xl font-bold tracking-[0.5em] uppercase mb-4">COMING UP:</p>
                                    <h2 className="text-6xl font-bold text-yellow-400 drop-shadow-lg">{currentCategory}</h2>
                                </div>
                            ) : (
                                <div className="mb-12 animate-pulse">
                                    <p className="text-4xl font-bold text-white">Join the game now!</p>
                                </div>
                            )}

                            <div className="w-full bg-slate-800/50 backdrop-blur-md rounded-3xl p-8 border border-slate-700">
                                <div className="flex justify-between items-end mb-6 border-b border-slate-600 pb-4">
                                    <span className="text-3xl font-bold">TEAMS JOINED</span>
                                    <span className="text-5xl font-mono text-green-400">{players.length}</span>
                                </div>
                                <div className="grid grid-cols-4 gap-4 max-h-64 overflow-y-auto pr-2">
                                    {players.map(p=>(
                                        <div key={p.id} className="bg-slate-700 p-4 rounded-xl text-center font-bold text-lg animate-bounce-in shadow-lg border border-slate-600 truncate">
                                            {p.name}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (gameState.status === 'leaderboard') return <div className="fixed inset-0 bg-slate-900 flex flex-col items-center justify-center p-12"><h1 className="text-6xl font-bold text-yellow-400 mb-12">TOP 5</h1><div className="w-full max-w-4xl space-y-4">{players.slice(0,5).map((p,i)=><div key={p.id} className="flex items-center bg-slate-800 p-6 rounded-2xl border-2 border-slate-700"><div className="text-4xl font-black mr-8 w-12">{i+1}</div><div className="text-3xl font-bold flex-1">{p.name}</div><div className="text-4xl font-mono text-purple-400">{p.score}</div></div>)}</div></div>;

            const currentQ = questions[gameState.currentQuestionIndex];
            if (!currentQ) return <div>End of questions</div>;

            if (currentQ.type === 'buzzer') {
                return <div className="fixed inset-0 bg-slate-900 text-white flex flex-col items-center justify-center"><div className={`absolute inset-0 transition-colors duration-300 ${gameState.buzzedPlayer?'bg-red-900/50':'bg-slate-900'}`}></div><div className="z-10 text-center max-w-6xl p-8"><span className="text-2xl uppercase font-bold text-yellow-500 mb-4 block tracking-[0.5em]">{currentQ.category}</span><h2 className="text-6xl font-bold leading-tight mb-12">{currentQ.question}</h2>{gameState.buzzedPlayer ? <div className="animate-bounce"><p className="text-3xl text-slate-300 mb-4">BUZZED IN:</p><div className="bg-white text-red-600 text-8xl font-black px-12 py-8 rounded-3xl shadow-xl border-8 border-red-600">{gameState.buzzedPlayer.name}</div></div> : <div className="flex flex-col items-center animate-pulse opacity-50"><Hand size={120} className="mb-4 text-slate-500"/><p className="text-4xl font-bold text-slate-500">WAITING FOR BUZZ...</p></div>}</div></div>;
            }

            return (
                <div className="fixed inset-0 overflow-hidden bg-slate-900 text-white flex flex-col">
                    <div className="h-20 px-8 flex justify-between items-center bg-slate-800 border-b border-slate-700 shrink-0">
                        <span className="text-2xl font-bold text-slate-400 uppercase tracking-widest truncate">{currentQ.category}</span>
                        <div className={`font-mono font-black px-4 py-1 rounded-xl border-4 ${timeLeft <= 5 ? 'text-red-500 border-red-500 animate-pulse' : 'text-white border-slate-600'} text-5xl shadow-2xl bg-slate-900`}>{timeLeft}s</div>
                    </div>
                    <div className="flex-1 flex flex-col items-center justify-end p-4 relative w-full max-w-[95vw] mx-auto overflow-hidden">
                        {(currentQ.mediaType === 'image' || currentQ.mediaType === 'video') && (
                            <div className="flex-1 w-full flex items-center justify-center min-h-0 mb-4">
                                {currentQ.mediaType === 'image' && <img src={currentQ.mediaUrl} alt="Riddle" className="max-h-full max-w-full object-contain rounded-xl shadow-2xl border-2 border-white/20"/>}
                                {currentQ.mediaType === 'video' && (
                                     <div className="aspect-video h-full max-h-full rounded-xl overflow-hidden shadow-2xl border-2 border-white/20 bg-black">
                                        <video className="w-full h-full" controls autoPlay>
                                            <source src={currentQ.mediaUrl} type="video/mp4" />
                                            Your browser does not support the video tag.
                                        </video>
                                     </div>
                                )}
                            </div>
                        )}
                        
                        <h2 className={`${(currentQ.mediaType) ? 'text-3xl' : 'text-5xl md:text-6xl mb-12'} font-bold text-center leading-tight mb-6 shrink-0 z-10 drop-shadow-lg`}>{currentQ.question}</h2>
                        
                        {/* OPTIONS or OPEN ANSWER DISPLAY */}
                        {currentQ.type === 'options' ? (
                            <div className="grid grid-cols-2 gap-4 w-full h-[25vh] shrink-0 z-10">
                                {currentQ.options.map((opt, i) => {
                                    const colors = ['bg-red-600','bg-blue-600','bg-yellow-500','bg-green-600'];
                                    const isCorrect = gameState.status === 'reveal' && i === currentQ.correctAnswer;
                                    const isDimmed = gameState.status === 'reveal' && i !== currentQ.correctAnswer;
                                    return <div key={i} className={`rounded-2xl flex items-center justify-center shadow-2xl transition-all relative overflow-hidden ${colors[i]} ${isDimmed?'opacity-20 grayscale':'opacity-100'} ${isCorrect?'scale-105 z-10 ring-4 ring-white':''}`}><div className="absolute left-4 text-3xl font-black text-black/20">{['▲','◆','●','■'][i]}</div><span className="text-2xl md:text-3xl font-bold text-white shadow-black drop-shadow-md text-center px-2">{opt}</span></div>;
                                })}
                            </div>
                        ) : (
                            // OPEN QUESTION REVEAL
                            <div className="w-full h-[25vh] shrink-0 z-10 flex items-center justify-center">
                                {gameState.status === 'reveal' ? (
                                    <div className="bg-green-600 p-8 rounded-3xl shadow-2xl border-4 border-white animate-bounce-in max-w-4xl text-center">
                                        <p className="text-xl text-green-200 uppercase font-bold tracking-widest mb-2">ANSWER:</p>
                                        <p className="text-4xl md:text-6xl font-bold text-white">{currentQ.answerString}</p>
                                    </div>
                                ) : (
                                    <div className="text-slate-500 text-2xl font-bold animate-pulse">Thinking time...</div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<PubQuizApp />);
    </script>
</body>
</html>