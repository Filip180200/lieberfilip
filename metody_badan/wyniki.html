<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Wynik√≥w (Nauczyciel)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- TWOJA KONFIGURACJA (WKLEJONA) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBbqbrD-VJgLQw9HtXgXE6hccQNBfE7OhM",
            authDomain: "zajecia6.firebaseapp.com",
            projectId: "zajecia6",
            storageBucket: "zajecia6.firebasestorage.app",
            messagingSenderId: "464023535230",
            appId: "1:464023535230:web:c147bde7dddd020d0d222f"
        };

        const COLLECTION_NAME = 'zajecia_6_csv_export';

        function Dashboard() {
            const [data, setData] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [dbInstance, setDbInstance] = React.useState(null);
            const [error, setError] = React.useState(null);
            const chartRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                const init = async () => {
                    try {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        setDbInstance(db);
                        await signInAnonymously(auth);

                        // Nas≈Çuchiwanie kolekcji w czasie rzeczywistym
                        const q = query(collection(db, COLLECTION_NAME));
                        
                        onSnapshot(q, (snapshot) => {
                            const docs = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                            setData(docs);
                            setLoading(false);
                        }, (err) => {
                             setError("B≈ÇƒÖd pobierania: " + err.message + ". Sprawd≈∫ regu≈Çy bazy (Firestore Rules)!");
                             setLoading(false);
                        });
                    } catch (err) {
                        setError("B≈ÇƒÖd inicjalizacji: " + err.message);
                        setLoading(false);
                    }
                };
                init();
            }, []);

            // Rysowanie wykresu
            React.useEffect(() => {
                if (!canvasRef.current || data.length === 0) return;
                
                const counts = [0, 0, 0, 0, 0];
                data.forEach(d => {
                    if (d.rating >= 1 && d.rating <= 5) counts[d.rating - 1]++;
                });

                if (chartRef.current) chartRef.current.destroy();
                
                chartRef.current = new Chart(canvasRef.current, {
                    type: 'bar',
                    data: {
                        labels: ['1 (Pora≈ºka)', '2', '3', '4', '5 (Sukces)'],
                        datasets: [{
                            label: 'Liczba g≈Ços√≥w',
                            data: counts,
                            backgroundColor: [
                                '#ef4444', '#f97316', '#eab308', '#3b82f6', '#22c55e'
                            ],
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
                });
            }, [data]);

            const downloadCSV = () => {
                if (data.length === 0) {
                    alert("Brak danych do pobrania.");
                    return;
                }

                let csvContent = "data:text/csv;charset=utf-8,";
                csvContent += "ID Studenta,Data,Ocena Trafno≈õci (1-5),Slowo 1,Slowo 2,Slowo 3,Slowo 4,Slowo 5,Slowo 6,Slowo 7,Slowo 8,Slowo 9,Slowo 10\n";
                
                data.forEach(row => {
                    const date = row.timestamp ? new Date(row.timestamp.seconds * 1000).toLocaleString() : 'N/A';
                    const safeWords = (row.words || []).map(w => `"${w.replace(/"/g, '""')}"`); 
                    while(safeWords.length < 10) safeWords.push('""');
                    csvContent += `${row.uid},${date},${row.rating},${safeWords.join(",")}\n`;
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `wyniki_projekcji_${new Date().toLocaleDateString()}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const clearDB = async () => {
                if(!dbInstance) return;
                if(!confirm("UWAGA: Czy na pewno usunƒÖƒá WSZYSTKIE wyniki z bazy? Tej operacji nie mo≈ºna cofnƒÖƒá.")) return;
                const q = query(collection(dbInstance, COLLECTION_NAME));
                const snap = await getDocs(q);
                snap.forEach(d => deleteDoc(d.ref));
                alert("Baza zosta≈Ça wyczyszczona.");
            };

            if (error) return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-red-50 text-red-800">
                    <div className="bg-white p-8 rounded shadow border border-red-200 text-center">
                        <h2 className="text-xl font-bold mb-2">‚ö†Ô∏è WystƒÖpi≈Ç b≈ÇƒÖd</h2>
                        <p>{error}</p>
                    </div>
                </div>
            );

            if (loading) return <div className="min-h-screen flex items-center justify-center text-slate-500 text-xl font-bold animate-pulse">Pobieranie danych z bazy...</div>;

            return (
                <div className="max-w-7xl mx-auto p-4 md:p-8">
                    
                    {/* Header */}
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div className="mb-4 md:mb-0">
                            <h1 className="text-3xl font-bold text-slate-800">Panel Wynik√≥w</h1>
                            <div className="text-slate-500 mt-1">Liczba wype≈Çnionych ankiet: <strong className="text-blue-600 text-lg">{data.length}</strong></div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={downloadCSV} className="bg-green-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-green-700 shadow-md flex items-center gap-2 transition transform hover:-translate-y-0.5">
                                <span className="text-xl">üì•</span> POBIERZ PLIK CSV
                            </button>
                            <button onClick={clearDB} className="bg-red-50 text-red-600 px-4 py-3 rounded-lg font-medium hover:bg-red-100 border border-red-200 transition">
                                üóëÔ∏è Wyczy≈õƒá Bazƒô
                            </button>
                        </div>
                    </div>

                    <div className="grid lg:grid-cols-2 gap-8">
                        
                        {/* Wykres */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                            <h2 className="text-xl font-bold mb-6 text-slate-700 flex items-center gap-2">
                                üìä Rozk≈Çad Ocen Trafno≈õci
                            </h2>
                            <canvas ref={canvasRef}></canvas>
                            <p className="text-center text-sm text-slate-400 mt-4">1 = Opis nietrafny, 5 = Opis bardzo trafny</p>
                        </div>

                        {/* PodglƒÖd S≈Ç√≥w */}
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex flex-col h-[500px]">
                            <h2 className="text-xl font-bold mb-4 text-slate-700 flex items-center gap-2">
                                üß† Chmura Skojarze≈Ñ
                            </h2>
                            <div className="flex-1 overflow-y-auto pr-2">
                                {Array.from({length: 10}).map((_, i) => (
                                    <div key={i} className="mb-6 border-b border-slate-100 pb-4 last:border-0">
                                        <div className="flex items-center gap-2 mb-2">
                                            <span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold uppercase">Tablica {i+1}</span>
                                            <span className="text-xs text-slate-400">({data.filter(d => d.words && d.words[i]).length} odpowiedzi)</span>
                                        </div>
                                        <div className="flex flex-wrap gap-1.5">
                                            {data.map((d, idx) => (
                                                d.words && d.words[i] ? 
                                                <span key={idx} className="bg-slate-50 border border-slate-200 px-2 py-1 text-xs rounded text-slate-600 hover:bg-slate-100 transition" title={d.words[i]}>
                                                    {d.words[i].length > 20 ? d.words[i].substring(0, 20) + '...' : d.words[i]}
                                                </span> 
                                                : null
                                            ))}
                                            {data.length === 0 && <span className="text-xs text-slate-300 italic">Brak danych</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>