<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eksperyment Percepcji</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: sans-serif; }
        .inkblot { filter: contrast(120%) brightness(95%); transition: opacity 0.5s; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- TWOJA KONFIGURACJA (WKLEJONA) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBbqbrD-VJgLQw9HtXgXE6hccQNBfE7OhM",
            authDomain: "zajecia6.firebaseapp.com",
            projectId: "zajecia6",
            storageBucket: "zajecia6.firebasestorage.app",
            messagingSenderId: "464023535230",
            appId: "1:464023535230:web:c147bde7dddd020d0d222f"
        };

        const COLLECTION_NAME = 'zajecia_6_csv_export';

        // Linki do obraz√≥w Rorschacha
        const IMAGES = [
            { id: 1, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_01.jpg&width=800" },
            { id: 2, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_02.jpg&width=800" },
            { id: 3, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_03.jpg&width=800" },
            { id: 4, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_04.jpg&width=800" },
            { id: 5, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_05.jpg&width=800" },
            { id: 6, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_06.jpg&width=800" },
            { id: 7, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_07.jpg&width=800" },
            { id: 8, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_08.jpg&width=800" },
            { id: 9, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_09.jpg&width=800" },
            { id: 10, src: "https://commons.wikimedia.org/w/index.php?title=Special:Redirect/file/Normalized_Rorschach_blot_10.jpg&width=800" }
        ];

        const BARNUM_TEXT = `
        "Analiza wskazuje, ≈ºe masz w sobie spory potencja≈Ç, kt√≥rego jeszcze w pe≈Çni nie wykorzysta≈Çe≈õ na swojƒÖ korzy≈õƒá. 
        Mimo ≈ºe na zewnƒÖtrz potrafisz sprawiaƒá wra≈ºenie osoby opanowanej i zdyscyplinowanej, wewnƒÖtrz zdarza Ci siƒô odczuwaƒá niepok√≥j i niepewno≈õƒá. 
        Cenisz sobie niezale≈ºno≈õƒá my≈õlenia i nie przyjmujesz twierdze≈Ñ innych bez wystarczajƒÖcych dowod√≥w. 
        Czasami bywasz ekstrawertyczny i towarzyski, a innym razem introwertyczny, ostro≈ºny i zdystansowany."
        `;

        function App() {
            const [step, setStep] = React.useState('intro'); 
            const [imgIndex, setImgIndex] = React.useState(0);
            const [words, setWords] = React.useState([]);
            const [input, setInput] = React.useState('');
            const [progress, setProgress] = React.useState(0);
            const [dbInstance, setDbInstance] = React.useState(null);
            const [user, setUser] = React.useState(null);
            const [isSaving, setIsSaving] = React.useState(false);

            React.useEffect(() => {
                const initFirebase = async () => {
                    try {
                        const app = initializeApp(firebaseConfig);
                        const auth = getAuth(app);
                        const db = getFirestore(app);
                        setDbInstance(db);
                        
                        const userCred = await signInAnonymously(auth);
                        setUser(userCred.user);
                    } catch (err) {
                        alert("B≈ÇƒÖd po≈ÇƒÖczenia z bazƒÖ: " + err.message);
                    }
                };
                initFirebase();
            }, []);

            const nextImage = () => {
                if(!input.trim()) return;
                setWords([...words, input]);
                setInput('');
                
                if (imgIndex < IMAGES.length - 1) {
                    setImgIndex(imgIndex + 1);
                } else {
                    setStep('processing');
                    let p = 0;
                    const interval = setInterval(() => {
                        p += 2;
                        setProgress(p);
                        if (p >= 100) {
                            clearInterval(interval);
                            setStep('result');
                        }
                    }, 40);
                }
            };

            const submitRating = async (rating) => {
                if (!dbInstance || !user) {
                    alert("Nie mo≈ºna zapisaƒá - brak po≈ÇƒÖczenia z bazƒÖ.");
                    return;
                }
                setIsSaving(true);
                try {
                    // Zapisujemy bezpo≈õrednio do kolekcji 'zajecia_6_csv_export'
                    await addDoc(collection(dbInstance, COLLECTION_NAME), {
                        words: words,
                        rating: rating,
                        timestamp: serverTimestamp(),
                        uid: user.uid
                    });
                    setStep('thankyou');
                } catch (e) {
                    console.error(e);
                    alert("B≈ÇƒÖd zapisu: " + e.message + "\n\nSprawd≈∫ w Firebase Console, czy w zak≈Çadce 'Firestore Database -> Rules' masz ustawiony tryb testowy!");
                    setIsSaving(false);
                }
            };

            if (step === 'intro') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-4 text-center">
                    <div className="bg-white p-8 rounded-xl shadow-xl max-w-md w-full">
                        <div className="text-4xl mb-4">üëÅÔ∏è</div>
                        <h1 className="text-2xl font-bold mb-4 text-slate-800">Eksperyment Percepcji</h1>
                        <p className="mb-8 text-slate-600">
                            Zobaczysz 10 tablic testu projekcyjnego. Przy ka≈ºdej wpisz <strong>jedno s≈Çowo</strong>, kt√≥re pierwsze przychodzi Ci na my≈õl.
                        </p>
                        <button onClick={() => setStep('test')} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition">Rozpocznij</button>
                    </div>
                </div>
            );

            if (step === 'test') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-4 md:p-6 rounded-xl shadow-lg max-w-2xl w-full">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <span className="text-sm font-bold text-slate-500">TABLICA {imgIndex + 1} / {IMAGES.length}</span>
                            <div className="flex gap-1">
                                {IMAGES.map((_, i) => (
                                    <div key={i} className={`h-1.5 w-4 rounded-full ${i <= imgIndex ? 'bg-blue-500' : 'bg-slate-200'}`}></div>
                                ))}
                            </div>
                        </div>
                        
                        <div className="bg-white mb-6 flex items-center justify-center border border-slate-100 rounded-lg p-4" style={{minHeight: '350px'}}>
                            <img src={IMAGES[imgIndex].src} className="max-w-full max-h-[400px] object-contain inkblot" alt="Inkblot" />
                        </div>
                        
                        <div className="flex flex-col sm:flex-row gap-3">
                            <input 
                                autoFocus
                                type="text" 
                                value={input}
                                onChange={e => setInput(e.target.value)}
                                onKeyDown={e => e.key === 'Enter' && nextImage()}
                                placeholder="Co widzisz? (jedno s≈Çowo)"
                                className="border-2 border-slate-200 p-3 w-full rounded-lg outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition"
                            />
                            <button onClick={nextImage} disabled={!input.trim()} className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold disabled:opacity-50 hover:bg-blue-700 transition">
                                Dalej
                            </button>
                        </div>
                    </div>
                </div>
            );

            if (step === 'processing') return (
                <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white">
                    <div className="text-4xl mb-6 animate-bounce">üß†</div>
                    <h2 className="text-2xl font-bold mb-2">Analiza skojarze≈Ñ...</h2>
                    <p className="text-slate-400 mb-8 text-sm">Przetwarzanie wzorc√≥w semantycznych</p>
                    <div className="w-64 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                        <div className="h-full bg-blue-500 transition-all duration-75 ease-out" style={{width: `${progress}%`}}></div>
                    </div>
                </div>
            );

            if (step === 'result') return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="bg-white p-8 rounded-xl shadow-lg max-w-2xl w-full fade-in">
                        <h2 className="text-xl font-bold mb-4 text-slate-800">Tw√≥j Profil Projekcyjny</h2>
                        <div className="bg-blue-50 p-6 border-l-4 border-blue-500 text-slate-700 italic mb-8 leading-relaxed text-lg rounded-r-lg">
                            {BARNUM_TEXT}
                        </div>
                        <div className="text-center">
                            <p className="mb-4 text-sm font-bold text-slate-500 uppercase tracking-wide">Oce≈Ñ trafno≈õƒá tego opisu (1-5)</p>
                            
                            {isSaving ? (
                                <div className="text-blue-600 font-bold animate-pulse">Zapisywanie wyniku...</div>
                            ) : (
                                <div className="flex justify-center gap-3">
                                    {[1,2,3,4,5].map(r => (
                                        <button key={r} onClick={() => submitRating(r)} className="w-12 h-12 md:w-14 md:h-14 rounded-full border-2 border-blue-100 text-blue-600 font-bold text-xl hover:bg-blue-600 hover:text-white hover:border-blue-600 transition shadow-sm">
                                            {r}
                                        </button>
                                    ))}
                                </div>
                            )}
                            
                            <div className="flex justify-between w-64 mx-auto mt-2 text-xs text-slate-400 font-medium">
                                <span>1 - Nietrafne</span><span>5 - Bardzo trafne</span>
                            </div>
                        </div>
                    </div>
                </div>
            );

            if (step === 'thankyou') return (
                <div className="min-h-screen flex flex-col items-center justify-center text-center p-4 fade-in">
                    <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center text-4xl mb-6 text-green-600 shadow-sm">‚úì</div>
                    <h2 className="text-3xl font-bold text-slate-800 mb-2">Dziƒôkujƒô!</h2>
                    <p className="text-slate-600">Tw√≥j wynik zosta≈Ç pomy≈õlnie zapisany.</p>
                    <p className="text-slate-400 text-sm mt-8">Mo≈ºesz zamknƒÖƒá to okno.</p>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>